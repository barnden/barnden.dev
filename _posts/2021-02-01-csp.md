---
layout: post
title:  "content security policy"
date:   2021-02-01 13:09:56
categories: "web"
---

The **Content-Security-Policy** (CSP) HTTP header tells the browser which sources it could trust with loading content from.

Enabling inline styles or inline scripts is not generally a good idea, however, with some libraries (MathJax) it is simply not possible to use them without enabling some sort of inline style or script.

## Using CSP with Jekyll
[Jekyll](https://jekyllrb.com/) generates static pages, and by using a simplistic theme that does not rely on JavaScript, I am able to serve nearly all content through `barnden.dev` or `static.barnden.dev`.

Initially, the theme used [Google Fonts](https://fonts.google.com/) to import web fonts to use, but eventually I transitioned over to self hosting my fonts at `static.barnden.dev`.

### Supporting MathJax
Normally with MathJax, the configuration file would be an inline script, which would require `unsafe-inline` for `script-src` which essentially defeats the purpose of CSP. At first, I moved the configuration over to its own file, which was allowed under the `self` directive. But, I was still importing the MathJax source from a CDN, which required another host exemption in `script-src`. And MathJax still required exemptions for the inline styles that it generated, and I was unwilling to use `unsafe-inline`.

Using [jekyll-mathjax-csp](https://github.com/fmeum/jekyll-mathjax-csp/tree/switch_to_mathjax_3), I am able to render the MathJax server-side, which solves the issue of using external JS. As hinted by the name of the plugin, it also generates hashes to include in the CSP to ensure the math renders properly.


However, with the number of pages that use MathJax the CSP header quickly got cluttered with hashes. This was not ideal, as I was sending over 50 different SHA256 hashes with each header. So, I [forked jekyll-mathjax-csp](https://github.com/barnden/jekyll-mathjax-csp) added a feature that generates a `csp.conf` file that could be imported into the `barnden.dev` nginx server config.

```nginx
location /2021/01/noise-functions {
    add_header Content-Security-Policy
        "default-src 'self' https://static.barnden.dev;
         style-src 'self' https://static.barnden.dev
            'sha256-zH6jtiFvbKu2rFJCHatF+N2xg6ZGirQdRrDpSagk12c=';
         font-src 'self' https://static.barnden.dev;
         worker-src 'self' https://static.barnden.dev;"
        always;
}
```
<figcaption class="center" markdown="1">
A location block from the resulting `csp.conf` file. Ignore the invalid syntax, it was formatted to look nice at that expense.
</figcaption>

The `csp.conf` file would allow me to selectively apply CSP options to certain resources. In the above example, when a user navigates to `/2021/01/noise-functions`, a specific CSP header containing only the hashes used on the page will be sent, as opposed to every hash for every page.

This then presents a new problem: I need to send CSP headers for all pages that **do not**have MathJax on them. Adding another `add_header` will send a duplicate CSP header to the browser, which should select the more restrictive of the two CSP headers. This meant all the inline styles for MathJax will not be rendered if the default CSP does not contain the hashes, which brings us back to the original problem.

**Possible Solutions:**
- Adding all the hashes to the default CSP header
  - Defeats the entire purpose of this exercise, as nginx will be sending even more data through headers.
- Generating location directive(s) selecting all the pages that don't have MathJax.
  - Inefficient, the plugin now has to generate a location directive for every single page
  - Configuration bloat, this is inevitable by creating selective CSP headers, but the amount of bloat generated by this method would be excessive.
- Install a module/plugin that prevents header duplication/modifying headers
  - These modules are not present in the distro's default nginx package, and I do not want to compile nginx with these features enabled
- Roll my own server/web app to serve behind nginx
  - The machine I am hosting this server on is a f1-micro from GCP's free-tier, it has one shared core and half a gigabyte of RAM. Therefore, I do not want to use up the very limited resources by having another server, nor require any extra resources for computing hashes/inserting nonces on demand.
- Host on Github Pages
  - I want to have as much control over my site as possible, and use plugins that aren't included with gh-pages.
- Using the `map` directive in the nginx config allows me to create if-like logic based on `$uri` for the CSP header.
  - Unfortunately, the `map` directive is not allowed inside a `server` block, which was where I was initially planning to import the `csp.conf`.
  - See [if is evil](https://www.nginx.com/resources/wiki/start/topics/depth/ifisevil/) for why *not* to use `if`.

Out of the possible solutions, the last is one of the simplest and happens to solve every issue. The `map` directive can map the value of one variable to another value, and store it in another variable. In this case, it would set `$csp` to a string that would be sent out as the CSP header that is based on the content of the `$uri` variable. The map directive also has a fallback to a default value, which is exacly what was lacking in the original implementation.


So, I rewrote the section of the plugin that generated the `csp.conf` to make the switch-like map directive.

```nginx
map $uri $csp {
    default "default csp header";
    "/2021/01/noise-functions" "CSP header with hash for MathJax style";
    # and so on...
}
```

With this, I had to modify my nginx config to import the `csp.conf` into a `http` block instead of a `server` block. Inside of the config for `barnden.dev`, I put the following command to send out the CSP header containing the mapped `$csp` variable:
```nginx
add_header Content-Security-Policy $csp always;
```

### Compatibility with jekyll-minify
Then, I realized that due to [jekyll-minifier](https://github.com/digitalsparky/jekyll-minifier), the hashes would change when the inline CSS was minified, causing the inline styles to not render. To combat this, I modified my fork of jekyll-mathjax-csp to automatically minify the inline styles generated by MathJax, regardless of the `JEKYLL_ENV` environment variable. The CSS is minified using [cssminify2](https://rubygems.org/gems/cssminify2/versions/2.0.1), the same as jekyll minifier, hopefully this means that the CSS source will not be modified when the rest of the document is minified later for production.

### Why not katex?
Before doing all the work to make MathJax play nice with CSP, and CSP with nginx, I attempted to switch to katex. There is [jekyll-katex](https://github.com/linjer/jekyll-katex) which renders math server-side as well, and is much faster than MathJax. Switching to katex would reduce the time to compile all the pages on my site (albeit, with a reduced subset of \\(\LaTeX\\) features).

For me, the web fonts (both over CDN and self hosted) did not seem to load, nor the math render how I expected it when comparing against the [katex website](https://katex.org/) (even with CSP and content blockers disabled). Also, using more Liquid tags inside my markdown files felt extremely cumbersome (even with using snippets bound to keyboard shortcuts), but this is not a major issue that would prevent me from adopting katex.
